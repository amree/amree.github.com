<!doctype html><html lang=en><head><title>Exporting data from RDS to S3 using AWS Glue :: Amree Zaid</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Overview Why would we even want to do this? Just imagine if you have data that are infrequently accessed. Keeping it in your RDS might costs you more than it should. Besides, having big table is gonna cause you a bigger headache with your database maintenance (indexing, auto vacuum, etc).
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://amree.github.io/posts/exporting-data-from-rds-to-s3-using-aws-glue/><link rel=stylesheet href=https://amree.github.io/assets/style.css><link rel=stylesheet href=https://amree.github.io/assets/green.css><link rel=apple-touch-icon href=https://amree.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://amree.github.io/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Exporting data from RDS to S3 using AWS Glue"><meta property="og:description" content="Overview Why would we even want to do this? Just imagine if you have data that are infrequently accessed. Keeping it in your RDS might costs you more than it should. Besides, having big table is gonna cause you a bigger headache with your database maintenance (indexing, auto vacuum, etc).
"><meta property="og:url" content="https://amree.github.io/posts/exporting-data-from-rds-to-s3-using-aws-glue/"><meta property="og:site_name" content="Amree Zaid"><meta property="og:image" content="https://amree.github.io/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-10-05 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Amree Zaid</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://twitter.com/AmreeZaid>Twitter</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://twitter.com/AmreeZaid>Twitter</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://amree.github.io/posts/exporting-data-from-rds-to-s3-using-aws-glue/>Exporting data from RDS to S3 using AWS Glue</a></h1><div class=post-meta><span class=post-date>2020-10-05</span></div><span class=post-tags>#<a href=https://amree.github.io/tags/aws/>aws</a>&nbsp;</span><div class=post-content><div><h2 id=overview>Overview<a href=#overview class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Why would we even want to do this? Just imagine if you have data that are
infrequently accessed. Keeping it in your RDS might costs you more than it
should. Besides, having big table is gonna cause you a bigger headache with your
database maintenance (indexing, auto vacuum, etc).</p><p>What if we can store those data somewhere where it&rsquo;s gonna cost less and it&rsquo;s in
an even smaller size? You can read more about the cost-saving part
<a href=https://dev.to/cloudforecast/using-parquet-on-athena-to-save-money-on-aws-3fac>here</a>.
I&rsquo;ll be focusing on the how and not the why in this post.</p><p>Exporting data from RDS to S3 through AWS Glue and viewing it through AWS Athena
requires a lot of steps. But it’s important to understand the process from the
higher level.</p><p>IMHO, I think we can visualize the whole process as two parts, which are:</p><ul><li>Input: This is the process where we’ll get the data from RDS into S3 using AWS
Glue</li><li>Output: This is where we’ll use AWS Athena to view the data in S3</li></ul><p>It’s important to note both processes require almost similar steps. We need to
specify the database and table for both of them.</p><p>Database and table don’t exactly carry the same meaning as our normal
PostgreSQL. The database in this context is more like containers for the tables
and doesn’t really have any extra configurations.</p><p>The table is a little bit different as it has a schema attached to it. The table
in AWS Glue is just the metadata definition that represents your data and it
doesn’t have data inside it. The data is available somewhere else. It can be in
RDS/S3/other places.</p><p>How do we create a table? We can either create it manually or use Crawlers in
AWS Glue for that. We can also create a table from AWS Athena itself.</p><p>The database and tables that you see in AWS Glue will also be available in AWS
Athena.</p><h2 id=recommendations>Recommendations<a href=#recommendations class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>In order not to confuse ourselves, I think it’d better if we use different
database names for the input and output. We need to differentiate between
what’s the input and output for easier reference when we set up the AWS Glue
Job.</li><li>More will be added</li></ul><h2 id=steps>Steps<a href=#steps class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=prerequisite>Prerequisite<a href=#prerequisite class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=security>Security<a href=#security class=hanchor arialabel=Anchor>&#8983;</a></h4><blockquote><p>These security configurations are required to prevent errors when we ran AWS
Glue</p></blockquote><p>Amazon VPC Endpoints for Amazon S3:</p><ul><li>Go to VPC > Endpoints</li><li>Create Endpoint</li><li>Search by Services: S3 (com.amazonaws.ap-southeast-1.s3)</li><li>Select your VPC</li><li>Tick a Route Table ID</li><li>Choose Full Access</li><li>Create Endpoint</li></ul><p>The result will be shown in the “Route Tables > Routes” page. There’ll be a new
route added with VPC as the target and S3 service as the destination</p><p>Reference: <a href=https://docs.aws.amazon.com/glue/latest/dg/vpc-endpoints-s3.html>https://docs.aws.amazon.com/glue/latest/dg/vpc-endpoints-s3.html</a></p><p>RDS Security Group:</p><ul><li>Select the security group of the database that you want to use</li><li>Edit inbound rules</li><li>Add rule</li><li>Type: All TCP</li><li>Source: Custom and search for the security group name itself</li><li>Save rules</li></ul><h4 id=roles>Roles<a href=#roles class=hanchor arialabel=Anchor>&#8983;</a></h4><p>This will allow Glue to call AWS service on our behalf</p><ul><li>Go to IAM > Roles > Create role</li><li>Type of trusted identity: AWS Service</li><li>Service: Glue</li><li>Next</li><li>Search and select AWSGlueServiceRole</li><li>Next</li><li>We can skip adding tags</li><li>Next</li><li>Roles: AWSGlueServiceDefault (can be anything)</li><li>Create Role</li></ul><h4 id=add-database-connections-for-input>Add Database Connections (for Input)<a href=#add-database-connections-for-input class=hanchor arialabel=Anchor>&#8983;</a></h4><ul><li>Go to AWS Glue > Databases > Connections</li><li>Click “Add Connection”</li><li>Connection type: Amazon RDS</li><li>Database Engine: PostgreSQL</li><li>Next</li><li>Instance: Choose an RDS</li><li>Put the database details: name, username, and password</li><li>Next</li><li>Review and click Finish</li><li>Use “Test Connection” in the “Connections” page to test it out (this might
take a while)</li></ul><h4 id=setup-s3-access-for-output>Setup S3 access (for Output)<a href=#setup-s3-access-for-output class=hanchor arialabel=Anchor>&#8983;</a></h4><ul><li>Go to AWS Glue > Databases > Connections</li><li>Click “Add Connection”</li><li>Connection type: Network</li><li>Next</li><li>VPC: Select the same one as the RDS*</li><li>Subnet: Select the same one as the RDS*</li><li>Security Group: default*</li><li>Next</li><li>Review and click Finish</li></ul><p>(*) Other options might work too, but I didn’t try them out.</p><h3 id=add-databases>Add Databases<a href=#add-databases class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This will be the parent/container for the table. A table might come from the
input and output.</p><ul><li>Go to AWS Glue > Databases > Add database</li><li>Database name: anything will do</li></ul><p>I created for both. E.g: <code>myapp_input</code> and <code>myapp_output</code></p><h3 id=add-crawlers>Add Crawlers<a href=#add-crawlers class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Before we create a job to import the data, we need to set up our input table’s
schema. This schema will be used for the data input in the Job later.</p><p>Naming is hard. I decided to go with this format:
<code>rds_db_name_env_table_name_crawler</code>. It’s easier if we can grasp what the
crawler does from the name even though we can have a shorter name and put the
details in the description.</p><ul><li>Go to AWS Glue > Tables > Add tables > Add tables using a crawler</li><li>Crawler name: Anything</li><li>Crawler source type: Data stores</li><li>Next</li><li>Choose a data store: JDBC</li><li>Connection: Choose the one we created above</li><li>Include path: <code>db_name/public/table_name</code> (assuming we want to take data from
table table_nameas we can use % as the wild card)</li><li>Next</li><li>Add another data store: No</li><li>Next</li><li>IAM role: Choose the one we created above (AWSGlueServiceDefault)</li><li>Next</li><li>Frequency</li><li>Use Run on demand</li><li>Next</li><li>Configure the crawler’s output</li><li>Database: Choose database for the crawler output (this will be the source for
our Job later)</li><li>Next</li><li>Review and click Finish</li></ul><p>The crawler that we’ve just defined is just to create a table with a schema
based on the RDS’s table that we just specified.</p><p>Let’s run it to see the output. Just go to the Crawlers page and select “Run
crawler”. It’ll take a moment before it starts and there’s no log when it’s
running (or at least I can’t find it yet). However, there’ll be a log once it’s
done. The only thing you can do to monitor its progress is to keep clicking the
Refresh icon on the Crawlers page.</p><p>Once it’s done, you’ll see the table created automatically in the Tables
section. You can filter out the list of the tables by going through Databases
first. You should see a table with defined schema similar to what you have in
RDS.</p><p>We need to add another crawler that will define the schema of our output. But
this time it’ll be for our S3 (which is the output)</p><ul><li>Go to AWS Glue > Tables > Add tables > Add tables using a crawler</li><li>Crawler name: Anything (I chose <code>s3_db_name_env_table_name_crawler</code>)</li><li>Next</li><li>Crawler source type: Data stores</li><li>Next</li><li>Choose a data store: S3</li><li>Connection: Use connection declared before for S3 access</li><li>Crawl data in: Specified path in my account</li><li>Include path: <code>s3://you-data-path/</code>. This will be the path where you’ll store
the output from Job that you’ll create later. The output here means the Apache
Parquet files. I chose: <code>s3://glue-dir/env/database_name/table_name/</code></li><li>Next</li><li>Add another data store: No</li><li>Next</li><li>Choose IAM role</li><li>Choose an existing IAM role</li><li>IAM role: AWSGlueServiceRoleDefault</li><li>Next</li><li>Create a schedule for this crawler:</li><li>Frequency: Run on demand</li><li>Next</li><li>Configure the crawler’s output:</li><li>Database: A database where you’ll store the output from S3</li><li>Next</li><li>Review and click Finish</li></ul><p>We’re not going to run this crawler yet as the S3 directory is empty. We’ll run
it once we’ve exported RDS data to S3.</p><h3 id=add-a-job>Add a job<a href=#add-a-job class=hanchor arialabel=Anchor>&#8983;</a></h3><p>For some unknown reason, I couldn’t get this to work without using AWS Glue
Studio. Maybe I’ll figure it out once I have more time. But I’ll just use AWS
Glue Studio for now:</p><ul><li>Open AWS Glue Studio in ETL section</li><li>Choose &ldquo;Create and manage jobs&rdquo;</li><li>Source: RDS</li><li>Target: S3</li><li>Click Create</li><li>Click on the “Data source - JDBC” node</li><li>Database: Use the database that we defined earlier for the input</li><li>Table: Choose the input table (should be coming from the same database)</li><li>You’ll notice that the node will now have a green check</li><li>Click on the “Data target - S3 bucket” node</li><li>Format: Glue Parquet</li><li>Compression type: Snappy</li><li>S3 Target location: This will the place where the parquet files will be
generated. This path should also be the same as what we defined in our crawler
for the output before. Remember, this is for the data, not for the schema. The
crawler is responsible for the schema. I chose to use
<code>s3://glue-dir/env/database_name/table_name</code></li><li>You’ll notice that the node will now have a green check</li><li>Now go to “Job details” tab</li><li>Name: Can be anything, I chose <code>rds_to_s3_db_name_env_table_name</code></li><li>IAM Role: Choose the role that we created before - AWSGlueServiceRoleDefault</li><li>Expand “Advanced Properties”</li><li>We’re going to specify some paths so that it won’t litter our top-level s3</li><li>Script path: <code>s3://glue-dir/scripts/</code></li><li>Spark UI logs path: <code>s3://glue-dir/sparkHistoryLogs/</code></li><li>Temporary path: <code>s3://glue-dir/temporary/</code></li><li>Click Save</li><li>Click “Run” to run the script. You can see the log in “Run details” tab. If
everything is working as expected, you should files generated in
<code>s3://glue-dir/env/database_name/table_name</code></li></ul><h3 id=viewing-the-record-using-aws-athena>Viewing the record using AWS Athena<a href=#viewing-the-record-using-aws-athena class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Before we can view the output, we need to create a table/schema for those
parquet files. This is the job for the crawler (you can also create the table
manually if you want to). That’s what the second crawler does. Just run the
crawler and you’ll get a new table created if it’s new. Refer to previous steps
on how we run the first crawler.</p><p>To confirm the table has been created, just go to the database for the output
and then click on the “Tables ..” link. You should see it there. There’s also an
alert at the top of the Crawler index page once it has finished the job.</p><p>To view the record:</p><ul><li>Go to AWS Athena</li><li>Select your database and table.</li><li>Click on the three dots on the right side of the table name and choose Preview
Table</li><li>You’ll see some data in the Results</li></ul><h2 id=references>References<a href=#references class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li><a href=https://github.com/aws-samples/aws-glue-samples/blob/master/FAQ_and_How_to.md>https://github.com/aws-samples/aws-glue-samples/blob/master/FAQ_and_How_to.md</a></li><li><a href=https://spark.apache.org/docs/2.1.0/sql-programming-guide.html>https://spark.apache.org/docs/2.1.0/sql-programming-guide.html</a></li><li><a href=https://aws.amazon.com/blogs/big-data/how-to-access-and-analyze-on-premises-data-stores-using-aws-glue/>https://aws.amazon.com/blogs/big-data/how-to-access-and-analyze-on-premises-data-stores-using-aws-glue/</a></li><li><a href=https://stackoverflow.com/questions/34948296/using-pyspark-to-connect-to-postgresql>https://stackoverflow.com/questions/34948296/using-pyspark-to-connect-to-postgresql</a></li><li><a href=https://dev.to/cloudforecast/watch-out-for-unexpected-s3-cost-when-using-athena-5hdm>https://dev.to/cloudforecast/watch-out-for-unexpected-s3-cost-when-using-athena-5hdm</a></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://amree.github.io/posts/how-to-integrate-tradingview-s-html5-charting-library-with-ruby-on-rails-v6/><span class=button__icon>←</span>
<span class=button__text>How to Integrate TradingView's HTML5 Charting Library with Ruby on Rails v6</span></a></span>
<span class="button next"><a href=https://amree.github.io/posts/order-update-with-two-step-payment/><span class=button__text>Order Update with Two-Step Payment</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://amree.github.io/assets/main.js></script><script src=https://amree.github.io/assets/prism.js></script></div></body></html>