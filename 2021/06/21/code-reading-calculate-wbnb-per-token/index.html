<!doctype html><html lang=en><head><title>Code Reading Calculate Wbnb per Token :: Amree Zaid</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Code Reading: Calculate WBNB per Token Given a token, how do calculate its value against WBNB?
Someone already solved this for us, but let us try to understand what the code is actually doing.
"><meta name=keywords content="cryptocurrency"><meta name=robots content="noodp"><link rel=canonical href=https://amree.github.io/2021/06/21/code-reading-calculate-wbnb-per-token/><link rel=stylesheet href=https://amree.github.io/assets/style.css><link rel=stylesheet href=https://amree.github.io/assets/green.css><link rel=apple-touch-icon href=https://amree.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://amree.github.io/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Code Reading Calculate Wbnb per Token"><meta property="og:description" content="Code Reading: Calculate WBNB per Token Given a token, how do calculate its value against WBNB?
Someone already solved this for us, but let us try to understand what the code is actually doing.
"><meta property="og:url" content="https://amree.github.io/2021/06/21/code-reading-calculate-wbnb-per-token/"><meta property="og:site_name" content="Amree Zaid"><meta property="og:image" content="https://amree.github.io/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-06-21 18:05:36 +0800 +0800"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Amree Zaid</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/all-posts>All Posts</a></li><li><a href=https://twitter.com/AmreeZaid>Twitter</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/all-posts>All Posts</a></li><li><a href=https://twitter.com/AmreeZaid>Twitter</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://amree.github.io/2021/06/21/code-reading-calculate-wbnb-per-token/>Code Reading Calculate Wbnb per Token</a></h1><div class=post-meta><span class=post-date>2021-06-21</span></div><div class=post-content><div><h1 id=code-reading-calculate-wbnb-per-token>Code Reading: Calculate WBNB per Token<a href=#code-reading-calculate-wbnb-per-token class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Given a token, how do calculate its value against WBNB?</p><p>Someone already solved this for us, but let us try to understand what the code is actually doing.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// src/exchange/pricing.ts
</span><span style=color:#75715e></span>
<span style=color:#75715e>/**
</span><span style=color:#75715e> * Search through graph to find derived BNB per token.
</span><span style=color:#75715e> * @todo update to be derived BNB (add stablecoin estimates)
</span><span style=color:#75715e> **/</span>
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>findBnbPerToken</span>(<span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Token</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>BigDecimal</span> {
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>WBNB_ADDRESS</span>) {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ONE_BD</span>;
  }
  <span style=color:#75715e>// loop through whitelist and check if paired with any
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>WHITELIST</span>.<span style=color:#a6e22e>length</span>; <span style=color:#f92672>++</span><span style=color:#a6e22e>i</span>) {
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pairAddress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>factoryContract</span>.<span style=color:#a6e22e>getPair</span>(<span style=color:#a6e22e>Address</span>.<span style=color:#a6e22e>fromString</span>(<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span>), <span style=color:#a6e22e>Address</span>.<span style=color:#a6e22e>fromString</span>(<span style=color:#a6e22e>WHITELIST</span>[<span style=color:#a6e22e>i</span>]));
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pairAddress</span>.<span style=color:#a6e22e>toHex</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>ADDRESS_ZERO</span>) {
      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pair</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Pair</span>.<span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>pairAddress</span>.<span style=color:#a6e22e>toHex</span>());
      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token0</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)) {
        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>token1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Token</span>.<span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1</span>);
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1Price</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>); <span style=color:#75715e>// return token1 per our token * BNB per token 1
</span><span style=color:#75715e></span>      }
      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)) {
        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>token0</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Token</span>.<span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token0</span>);
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token0Price</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>); <span style=color:#75715e>// return token0 per our token * BNB per token 0
</span><span style=color:#75715e></span>      }
    }
  }
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ZERO_BD</span>; <span style=color:#75715e>// nothing was found return 0
</span><span style=color:#75715e></span>}
</code></pre></div><p>Source: <a href=https://git.io/Jno0J>https://git.io/Jno0J</a></p><p>For this code walkthrough, we will assume that we are passing <code>CAKE</code> as the params. More information of this token can be found <a href=https://bscscan.com/address/0x0e09fabb73bd3ade0a17ecc321fd13a19e81ce82>here</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>WBNB_ADDRESS</span>) {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ONE_BD</span>;
}
</code></pre></div><p>This is quiet straightforward. If we are given <code>WBNB</code>, then we will just return <code>1</code> as the rate. E.g: Given <code>WBNB</code>, it will always return <code>1</code> as it is the same token. But we are passing <code>CAKE</code> here, so, we will be proceeding to the next line.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>WHITELIST</span>.<span style=color:#a6e22e>length</span>; <span style=color:#f92672>++</span><span style=color:#a6e22e>i</span>) {
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p><code>WHITELIST</code> here refers to:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>WHITELIST</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>[] <span style=color:#f92672>=</span> [
  <span style=color:#e6db74>&#34;0xbb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c&#34;</span>, <span style=color:#75715e>// WBNB
</span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;0xe9e7cea3dedca5984780bafc599bd69add087d56&#34;</span>, <span style=color:#75715e>// BUSD
</span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;0x55d398326f99059ff775485246999027b3197955&#34;</span>, <span style=color:#75715e>// USDT
</span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d&#34;</span>, <span style=color:#75715e>// USDC
</span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;0x23396cf899ca06c4472205fc903bdb4de249d6fc&#34;</span>, <span style=color:#75715e>// UST
</span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;0x7130d2a12b9bcbfae4f2634d864a1ee1ce3ead9c&#34;</span>, <span style=color:#75715e>// BTCB
</span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;0x2170ed0880ac9a755fd29b2688956bd959f933f8&#34;</span>, <span style=color:#75715e>// WETH
</span><span style=color:#75715e></span>];
</code></pre></div><p>Source: <a href=https://git.io/JnKXF>https://git.io/JnKXF</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pairAddress</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>factoryContract</span>.<span style=color:#a6e22e>getPair</span>(<span style=color:#a6e22e>Address</span>.<span style=color:#a6e22e>fromString</span>(<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span>), <span style=color:#a6e22e>Address</span>.<span style=color:#a6e22e>fromString</span>(<span style=color:#a6e22e>WHITELIST</span>[<span style=color:#a6e22e>i</span>]));
<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pairAddress</span>.<span style=color:#a6e22e>toHex</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>ADDRESS_ZERO</span>) {
  <span style=color:#75715e>// ..
</span><span style=color:#75715e></span>}
</code></pre></div><p>Assuming we are passing <code>CAKE</code> token, this means, the code in the loop will only continue if there is no matching pair. The order of the tokens in the pair doesn&rsquo;t really matter in this case.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>factoryContract</span>.<span style=color:#a6e22e>getPair</span>(<span style=color:#a6e22e>Address</span>.<span style=color:#a6e22e>fromString</span>(<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span>), <span style=color:#a6e22e>Address</span>.<span style=color:#a6e22e>fromString</span>(<span style=color:#a6e22e>WHITELIST</span>[<span style=color:#a6e22e>i</span>]))
</code></pre></div><p>We can try this manually with the factory address of PancakeSwap V2 at <a href=https://bscscan.com/address/0xca143ce32fe78f1f7019d7d551a6402fc5350c73#readContract>BscScan</a>. Just scroll to the <code>getPair</code> method and input the tokens that we want. If there are multiple pairs with similar tokens, it will return the first one it found based on the index (I may need to check the factory code to confirm this).</p><p>Let’s go to the next line of code</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pair</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Pair</span>.<span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>pairAddress</span>.<span style=color:#a6e22e>toHex</span>());
</code></pre></div><p>Nothing much here. This will just load the pair that we found earlier to <code>pair</code>. However, it is good to know that we will also get extra information such as the <code>reserveBNB</code>, <code>derivedBNB</code> and others. These information is not available on the network itself but it is something that <a href=https://github.com/pancakeswap/pancake-subgraph/>subgraph</a> stored. We can see all the attributes <a href=https://github.com/pancakeswap/pancake-subgraph/blob/a002a98487d7467bf283b2b9d3c9f7290d50cbd1/src/exchange/factory.ts#L74-L93>here</a>.</p><p>Now let us go to an important piece of the code in the function:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token0</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)) {
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)) {
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>As we can see here, the code is trying to find out <code>token</code> is in <code>token0</code> or <code>token1</code>. To those who don&rsquo;t know, we can get the <code>token0</code> and <code>token1</code> in the pair page at BscScan, an example would be this <a href=https://bscscan.com/address/0x0ed7e52944161450477ee417de9cd3a859b14fd0>page</a> for <code>CAKE-WBNB</code>.</p><p>Since we are passing <code>CAKE</code> in this walkthrough, it will be found in the first <code>if</code> as for the <code>CAKE-WBNB</code> pair, the <code>token0</code> is equal to <code>CAKE</code>. So, that should have solved this part:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token0</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span>
</code></pre></div><p>Let us move to the second condition:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)
</code></pre></div><p>The value of <code>MINIMUM_LIQUIDITY_THRESHOLD_BNB</code> is actually <code>10</code>. Source is <a href=https://git.io/Jn6vL>here</a>.</p><p>But what about <code>pair.reserveBNB</code>, what&rsquo;s the value? To answer that, we need to find out where it&rsquo;s actually being set first.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// src/exchange/core.ts
</span><span style=color:#75715e></span>
<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span> <span style=color:#f92672>=</span>
  <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve0</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>).<span style=color:#a6e22e>plus</span>(
    <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve1</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>)
  );
</code></pre></div><p>Source: <a href=https://git.io/Jn6ft>https://git.io/Jn6ft</a></p><p>Now we need to know where <code>token0.derivedBNB</code> is from, which is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// src/exchange/core.ts
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>t0DerivedBNB</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findBnbPerToken</span>(<span style=color:#a6e22e>token0</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>Token</span>);
<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>t0DerivedBNB</span>;
<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>save</span>();

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>t1DerivedBNB</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findBnbPerToken</span>(<span style=color:#a6e22e>token1</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>Token</span>);
<span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>t1DerivedBNB</span>;
<span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>save</span>();

<span style=color:#75715e>// ...
</span><span style=color:#75715e></span>
<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span> <span style=color:#f92672>=</span>
  <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve0</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>)
    .<span style=color:#a6e22e>plus</span>(
      <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve1</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>)
     );
</code></pre></div><p>Source: <a href=https://git.io/Jn6f6>https://git.io/Jn6f6</a></p><p>Wait, it’s actually calling the same function? Isn’t this going to cause infinite loop? Actually NO, as this function is being called in different time. To be specific, it will be called whenever the contract emit <code>SYNC</code> event. So, <code>derivedBNB</code> will always be updated with a value when that event happened. Source: <a href=https://git.io/Jn6TR>https://git.io/Jn6TR</a></p><p>So, we can can assume when <code>findBnbPerToken</code> is called, the <code>derivedBNB</code> value is already there. This is actually part of the code that confuses me as it feels like the value will never increase. But here is my guest:</p><ul><li><code>pair.reserveBNB</code>, <code>token0.derivedBNB</code> and <code>token1.derivedBNB</code> has initial value of <code>0</code></li><li>If we take an example of <code>CAKE/WBNB</code> pair, <code>findBnbPerToken</code> will always return <code>0</code> for <code>CAKE</code> as it doesn&rsquo;t meet the <code>MINIMUM_LIQUIDITY_THRESHOLD_BNB</code> until <code>WBNB</code> reserve which is also <code>pair.reserve1</code> in the pair has more than <code>MINIMUM_LIQUIDITY_THRESHOLD_BNB</code> or <code>10</code></li><li>This also means this code block depends entirely on the <code>WBNB</code> or <code>token1.derivedBNB</code> to have non zero value at first:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// src/exchange/core.ts
</span><span style=color:#75715e></span>
<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve0</span>
    .<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token0</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>)
    .<span style=color:#a6e22e>plus</span>(<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve1</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>));
</code></pre></div><p>Alright, let us go back up again to this condition again:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token0</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)) {
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)) {
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>Assuming the second condition has been met, we will go inside that <code>if</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>token1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Token</span>.<span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1</span>);
<span style=color:#75715e>// return token1 per our token * BNB per token 1
</span><span style=color:#75715e></span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1Price</span>.<span style=color:#a6e22e>times</span>(<span style=color:#a6e22e>token1</span>.<span style=color:#a6e22e>derivedBNB</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>BigDecimal</span>);
</code></pre></div><p>Source: <a href=https://git.io/JniYJ>https://git.io/JniYJ</a></p><p>I would say the final piece of the code is the most important part here. The first line is just to load the token information and in this case, we are going to load the other token. If the token that we passed (<code>CAKE</code>) is in the first position, then we are going to load the other token which is <code>WBNB</code> in this case.</p><p>Once we got <code>WBNB</code> loaded, we can calculate the value of this token agains <code>WBNB</code>. I&rsquo;ve already explained about <code>.derivedBNB</code> attribute before, but for this case, it&rsquo;s quiet straightforward as we are going to pass <code>WBNB</code> which will get us <code>1</code> as it is <code>WBNB/WBNB</code>.</p><p>So, we need to figure out the <code>pair.token1Price</code> now which is coming from:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// src/exchange/core.ts
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve0</span>.<span style=color:#a6e22e>notEqual</span>(<span style=color:#a6e22e>ZERO_BD</span>))
  <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1Price</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve1</span>.<span style=color:#a6e22e>div</span>(<span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserve0</span>);
<span style=color:#66d9ef>else</span>
  <span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>token1Price</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ZERO_BD</span>;
</code></pre></div><p>Source: <a href=https://git.io/JniOs>https://git.io/JniOs</a></p><p>In this case, we want to know the value of <code>WBNB/CAKE</code> and we are going to use the <code>reserve</code> amount. Reserve amounts can be retrieved from the pair&rsquo;s contract <code>getReserves</code> function which can be seen in this pair&rsquo;s <a href=https://bscscan.com/address/0x0ed7e52944161450477ee417de9cd3a859b14fd0#readContract>contract</a>.</p><p>After that, we will get the value of <code>1 WBNB</code> = <code>X CAKE</code>. Do remember the output is in <code>CAKE</code> and not <code>WBNB</code>. After that we can get of <code>CAKE</code> token in <code>WBNB</code> by <code>X CAKE * CAKE/WBNB</code></p><hr><p>To be honest, I am still not satisfied with this explanation. I will update this post in the future if I have a better way to do it, most probably with a real example. However, I think these are some of the keys that helped me (hopefully it will help you as well):</p><ul><li><code>findBnbPerToken</code> will produce output of <code>TOKEN_X/WBNB</code> with <code>TOKEN_X</code> as the argument</li><li>To simplified this, we can ignore this condition first:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>pair</span>.<span style=color:#a6e22e>reserveBNB</span>.<span style=color:#a6e22e>gt</span>(<span style=color:#a6e22e>MINIMUM_LIQUIDITY_THRESHOLD_BNB</span>)
</code></pre></div><ul><li>Most of the work will be done on the other token. If <code>TOKEN_X</code> is the first one, then we&rsquo;ll be doing calculation on the second token.</li></ul><p>Ugh, I’m still not satisfied with this post. Let us consider this post as v0.0.1 😅</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://amree.github.io/2021/05/09/speed-up-ruby-on-rails-development-environment/><span class=button__text>Speed Up Ruby on Rails Development Environment</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://amree.github.io/assets/main.js></script><script src=https://amree.github.io/assets/prism.js></script></div></body></html>